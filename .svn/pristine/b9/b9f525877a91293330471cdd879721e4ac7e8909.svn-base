<template>
<div>
    <div class="actions">
        <span>是否启用自定义流程：</span>
        <c-switch v-model="query.XXXPROP_DUTY_SCHEDULING_CUSTOM"></c-switch>
        <span class="desc">*红色表示在默认流程上添加的流程，或时间的变更</span>
        <c-button type="add" @click="inputItem({})">新增</c-button>
    </div>
    <div class="block-main">
        <div class="list">
            <page-table ref="table" remote="requestDutySchedulingList" :formatPayload="formatPayload" :row-class-name="rowClassName">
                <el-table-column prop="XXXPROP_DUTY_SCHEDULING_id" label="序号" width="50px"></el-table-column>
                <el-table-column prop="XXXPROP_DUTY_SCHEDULING_1" label="任务名称" />
                <el-table-column prop="XXXPROP_DUTY_SCHEDULING_2" label="任务开始时间" width="120px" />
                <el-table-column prop="XXXPROP_DUTY_SCHEDULING_3" label="任务结束时间" width="120px" />
                <el-table-column prop="XXXPROP_DUTY_SCHEDULING_4" label="任务说明" />
                <el-table-column label="是否提醒" width="80px">
                    <template slot-scope="scope">
                        <c-switch v-model="scope.row.XXXPROP_DUTY_SCHEDULING_5"></c-switch>
                    </template>
                </el-table-column>
                <el-table-column label="是否为产品" width="100px">
                    <template slot-scope="scope">
                        <c-switch v-model="scope.row.XXXPROP_DUTY_SCHEDULING_6"></c-switch>
                    </template>
                </el-table-column>
                <el-table-column prop="XXXPROP_DUTY_SCHEDULING_7" label="执行顺序" width="80px" />
                <el-table-column prop="XXXPROP_DUTY_SCHEDULING_8" label="关联产品" />
                <el-table-column label="是否完成" width="80px">
                    <template slot-scope="scope">
                        <c-switch v-model="scope.row.XXXPROP_DUTY_SCHEDULING_9"></c-switch>
                    </template>
                </el-table-column>
                <el-table-column label="状态" width="80px">
                    <template slot-scope="scope">
                        {{scope.row.XXXPROP_DUTY_SCHEDULING_10?'√':''}}
                    </template>
                </el-table-column>
                <el-table-column prop label="操作" width="150px">
                    <template slot-scope="scope">
                        <el-button type="text" size="small" @click="inputItem(scope.row)">编辑</el-button>
                        <c-button type="del" @click="onConfirmDelete(scope.row)">
                            <span class="text-danger">删除</span>
                        </c-button>
                    </template>
                </el-table-column>
            </page-table>
        </div>
    </div>
    <dialog-form title="值班流程配置" :visible.sync="visibleDialogFormItem" :getPayload="()=>formItem" :confirmDisabled="!formItem.XXXPROP_DUTY_SCHEDULING_1" remote="requestDialogFormDutySchedulingItemInput" v-if="formItem">
        <!-- <template v-slot:default="{ form }"> -->
        <template>
            <el-form-item label="任务来源" label-width="120px">
                <el-select v-model="formItem.XXXPROP_DUTY_SCHEDULING_X" placeholder="请选择">
                    <el-option label="个人" value="gr"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="任务名称" label-width="120px">
                <el-input v-model="formItem.XXXPROP_DUTY_SCHEDULING_1" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="执行顺序" label-width="120px">
                <el-input v-model="formItem.XXXPROP_DUTY_SCHEDULING_7" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="起止时间" label-width="120px">
                <el-date-picker v-model="formItemTimeRange" type="datetimerange" range-separator="至" start-placeholder="开始日期" end-placeholder="结束日期">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="是否提醒" label-width="120px">
                <c-switch v-model="formItem.XXXPROP_DUTY_SCHEDULING_5"></c-switch>
            </el-form-item>
            <div class="notition-options" v-if="formItem.XXXPROP_DUTY_SCHEDULING_5">
                <div>
                    <el-radio-group v-model="formItem.XXXPROP_DUTY_SCHEDULING_X3">
                        <el-radio-button label="XXXLABEL_DUTY_SCHEDULING_month">月</el-radio-button>
                        <el-radio-button label="XXXLABEL_DUTY_SCHEDULING_day">日</el-radio-button>
                        <el-radio-button label="XXXLABEL_DUTY_SCHEDULING_week">周</el-radio-button>
                    </el-radio-group>
                    <span v-if="formItem.XXXPROP_DUTY_SCHEDULING_X3=='XXXLABEL_DUTY_SCHEDULING_day'">时间类型：</span>
                    <el-radio-group v-model="formItem.XXXPROP_DUTY_SCHEDULING_X4" v-if="formItem.XXXPROP_DUTY_SCHEDULING_X3=='XXXLABEL_DUTY_SCHEDULING_day'">
                        <el-radio label="XXXLABEL_DUTY_SCHEDULING_roman">阳历</el-radio>
                        <el-radio label="XXXLABEL_DUTY_SCHEDULING_china">阴历</el-radio>
                    </el-radio-group>
                </div>
                <div>
                    <el-checkbox :indeterminate="isIndeterminate" v-model="checkAll" @change="handleCheckAllChange">全选</el-checkbox>
                    <div style="margin: 15px 0;"></div>
                    <el-checkbox-group v-model="checkedItems">
                        <el-checkbox v-for="(item,index) in checkItemOptions" :label="item.value" :key="index">{{item.name}}</el-checkbox>
                    </el-checkbox-group>
                </div>
            </div>
            <el-form-item label="是否为产品" label-width="120px">
                <c-switch v-model="formItem.XXXPROP_DUTY_SCHEDULING_6"></c-switch>
            </el-form-item>
            <el-form-item label="产品选择" label-width="120px" v-if="formItem.XXXPROP_DUTY_SCHEDULING_6">
                <el-cascader v-model="formItem.XXXPROP_DUTY_SCHEDULING_X2" :options="optionsOfCascaderFormInput"></el-cascader>
            </el-form-item>
            <el-form-item label="是否完成" label-width="120px">
                <c-switch v-model="formItem.XXXPROP_DUTY_SCHEDULING_9"></c-switch>
            </el-form-item>
        </template>
    </dialog-form>
</div>
</template>

<script>
import {
    requestDutySchedulingListDelItem
} from "@/common/remote/";
import {
    common,
    witchCommonList,
    withCommonLeftTree
} from '../../mixins/index';
export default {
    mixins: [common, witchCommonList, withCommonLeftTree],
    data() {
        return {
            query: {
                XXXPROP_DUTY_SCHEDULING_CUSTOM: true
            },
            formItemTimeRange: [],
            // checkAll: false,
            checkedItems: [],
            optionsOfCascaderFormInput: [{
                value: 'tzsqxt',
                label: '台州市气象台',
                children: [{
                    value: 'sx',
                    label: '首席',
                    children: [{
                        value: 'dqybsh',
                        label: '短期预报稿审核'
                    }]
                }]
            }]
        };
    },
    computed: {
        actionOfListDelItem() {
            return requestDutySchedulingListDelItem;
        },
        checkItemOptions() {
            return this.formItem ? ({
                'XXXLABEL_DUTY_SCHEDULING_month': (new Array(12)).fill('').map((e, i) => ({
                    name: `${i+1}月`,
                    value: `${i+1}`
                })),
                'XXXLABEL_DUTY_SCHEDULING_day': (new Array(31)).fill('').map((e, i) => ({
                    name: `${i+1}`,
                    value: `${i+1}`
                })),
                'XXXLABEL_DUTY_SCHEDULING_week': (new Array(4)).fill('').map((e, i) => ({
                    name: `${i+1}`,
                    value: `${i+1}`
                }))
            })[this.formItem.XXXPROP_DUTY_SCHEDULING_X3] : []
        },
        checkedCount() {
            const checkedItems = this.checkedItems || [];
            const checkedCount = checkedItems.length;
            return checkedCount;
        },
        isIndeterminate() {
            const {
                checkedCount,
                checkItemOptions = []
            } = this;
            return checkedCount > 0 && checkedCount < checkItemOptions.length
        },
        checkAll() {
            const {
                checkedCount,
                checkItemOptions = []
            } = this;
            return checkedCount == checkItemOptions.length
        }
    },
    watch: {
        'query.XXXPROP_DUTY_SCHEDULING_CUSTOM': function() {
            this.query.currentPage = 1;
            this.search();
        },
        formItemTimeRange(val) {
            const {
                formItem
            } = this;
            formItem.XXXPROP_DUTY_SCHEDULING_2 = val && val[0];
            formItem.XXXPROP_DUTY_SCHEDULING_3 = val && val[1];
        },
        checkItemOptions() {
            this.checkedItems = [];
        },
        'formItem.XXXPROP_DUTY_SCHEDULING_X3': function(val) {
            if (val == 'XXXLABEL_DUTY_SCHEDULING_day') {
                const {
                    formItem
                } = this;
                formItem.XXXPROP_DUTY_SCHEDULING_X4 = 'XXXLABEL_DUTY_SCHEDULING_roman'
            }
        }
    },
    methods: {
        getFormItemByInputItem(item = {}) {
            const {
                checkedItems
            } = this;
            const lastKeyItemClicked = checkedItems && checkedItems.id;
            this.formItemTimeRange = [item.XXXPROP_DUTY_SCHEDULING_2, item.XXXPROP_DUTY_SCHEDULING_3];
            return {
                "XXXPROP_DUTY_SCHEDULING_8": lastKeyItemClicked,
                "XXXPROP_DUTY_SCHEDULING_X3": 'XXXLABEL_DUTY_SCHEDULING_month',
                "XXXPROP_DUTY_SCHEDULING_X4": null,
                ...item
            };
        },
        handleCheckAllChange(val) {
            const {
                checkItemOptions
            } = this;
            this.checkedItems = val ? checkItemOptions.map(e => e.value) : [];
            // this.isIndeterminate = false;
        },
        handleCheckedItemChange(value) {
            let checkedCount = value.length;
            this.checkAll = checkedCount === this.cities.length;
            this.isIndeterminate = checkedCount > 0 && checkedCount < this.cities.length;
        },
        rowClassName({
            row,
            rowIndex
        }) {
            if (row.XXXPROP_DUTY_SCHEDULING_IMPRESS) {
                return 'row-impress'
            }
        }
    }
}
</script>

<style scoped>
.actions {
    margin-bottom: 10px;

    .desc {
        font-size: 15px;
        font-weight: 400;
        color: rgba(144, 147, 153, 1);
        line-height: 50px;
        padding-left: 40px;
        padding-right: 20px;
    }
}


.block-main {
    display: flex;

    >.list {
        flex: 1;
    }

    .left-tree {
        border: 1px solid #ddd;
        width: 220px;
    }
}

.notition-options {
    margin-left: 52px;
    padding: 20px 25px;
    background: rgba(246, 247, 251, 1);
    border-radius: 4px;
}
</style>
