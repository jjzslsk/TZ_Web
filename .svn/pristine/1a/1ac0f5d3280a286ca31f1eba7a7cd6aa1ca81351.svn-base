<template>
  <div>
    <el-container>
      <el-main>
        <el-card class="box-card" shadow="never">
          <div class="text">
            <div class="list">
              <page-table ref="table" remote="requestrulesList" :formatPayload="formatPayload">
                <div class="actions" slot="actions">
                  <span class="title">类型</span>
                  <el-select v-model="query.type" clearable placeholder="请选择">
                    <el-option
                      v-for="item in organList"
                      :label="item.name"
                      :value="item.id"
                      :key="item.id"
                    ></el-option>
                  </el-select>
                  <span class="title">名称：</span>
                  <el-input v-model="query.name" clearable placeholder></el-input>
                  <span class="title">内容</span>
                  <el-input v-model="query.content" clearable placeholder></el-input>
                  <c-button type="search" @click="search()">搜索</c-button>
                  <c-button type="add" @click="inputItem({})">添加</c-button>
                </div>
                <el-table-column prop label="序号" width="80px"></el-table-column>
                <el-table-column prop="name" label="名称" width="180px" />
                <el-table-column prop="type" label="类型" width="180px" />
                <el-table-column prop="content" label="内容"/>
                <!-- <el-table-column label="所属机构" width="180px" >
                                <template slot-scope="{row}">
                                    {{({'TZ':'台州市气象局','HY':'黄岩区气象局'})[row.XXXPROP_USER_4]}}
                                </template>
                </el-table-column>-->
                <el-table-column prop label="操作" width="200px">
                  <template slot-scope="scope">
                    <el-button type="text" size="small">编辑</el-button>
                    <c-button type="del">
                      <span class="text-danger">删除</span>
                    </c-button>
                  </template>
                </el-table-column>
              </page-table>
            </div>
          </div>
        </el-card>
      </el-main>
    </el-container>
    <dialog-form
      title="用户"
      :visible.sync="visibleDialogFormItem"
      :getPayload="()=>formItem"
      :confirmDisabled="!formItem.uid"
      remote="requestDialogFormUserItemInput"
      v-if="formItem"
      @success="submitSuccess"
    >
      <!-- <template v-slot:default="{ form }"> -->
      <template>
        <el-form-item label="姓名" label-width="120px">
          <el-input v-model="formItem.name" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="性别" label-width="120px">
          <el-select v-model="formItem.sex" placeholder="请选择">
            <el-option label="男" value="男"></el-option>
            <el-option label="女" value="女"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="手机" label-width="120px">
          <el-input v-model="formItem.phone" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="登录名" label-width="120px">
          <el-input v-model="formItem.uid" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="密码" label-width="120px">
          <el-input v-model="formItem.password" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="头像地址" label-width="120px">
          <el-input
            v-model="formItem.headPortrait"
            autocomplete="off"
            type="textarea"
            :autosize="{ minRows: 2, maxRows: 6}"
          ></el-input>
        </el-form-item>
        <el-form-item label="预报员编号" label-width="120px">
          <el-input v-model="formItem.forecaster" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="所属地区" label-width="120px">
          <el-select v-model="formItem.areaId" placeholder="请选择">
            <el-option v-for="item in areaData" :label="item.label" :value="item.id" :key="item.id"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="所属机构" label-width="120px">
          <el-select v-model="formItem.orgId" placeholder="请选择">
            <el-option v-for="item in organList" :label="item.name" :value="item.id" :key="item.id"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="所属角色" label-width="120px">
          <el-select v-model="formItem.roleId" placeholder="请选择">
            <el-option v-for="item in roleList" :label="item.name" :value="item.id" :key="item.id"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="邮箱" label-width="120px">
          <el-input v-model="formItem.email" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="邮编" label-width="120px">
          <el-input v-model="formItem.postCode" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="地址" label-width="120px">
          <el-input
            v-model="formItem.address"
            autocomplete="off"
            type="textarea"
            :autosize="{ minRows: 2, maxRows: 6}"
          ></el-input>
        </el-form-item>
      </template>
    </dialog-form>
  </div>
</template>

<script>
import {
  requestUserListDelItem,
  requestOrganList,
  requestRoleListItem,
  requestTreeChildrenOfAreaNode
} from "@/common/remote/";
import { common, witchCommonList } from "../../../mixins/index";
export default {
  mixins: [common, witchCommonList],
  data() {
    return {
      query: {
        // XXXPROP_USER_id: "",
        // XXXPROP_USER_name: ""
      },
      organList: "",
      areaData: "",
      roleList: []
    };
  },
  mounted() {
    requestOrganList({}).then(res => {
      if (res.success) {
        this.organList = res.data.list;
      }
    });
    requestTreeChildrenOfAreaNode().then(res => {
      this.areaData = [];
      this.treeOfList(res.data);
      console.log(this.areaData);
    });
    requestRoleListItem({}).then(res => {
      if (res.success) {
        this.roleList = res.data.list;
        console.log(this.roleList);
      }
    });
  },
  computed: {
    actionOfListDelItem() {
      return requestUserListDelItem;
    }
  },
  methods: {
    treeOfList(tree) {
      tree.map(item => {
        this.areaData.push(item);
        if (item.children) {
          this.treeOfList(item.children);
        }
      });
    },
    submitSuccess(res) {
      requestOrganList({}).then(res => {
        if (res.success) {
          this.organList = res.data.list;
        }
      });
      requestTreeChildrenOfAreaNode().then(res => {
        this.areaData = [];
        this.treeOfList(res.data);
        console.log(this.areaData);
      });
      // this.$refs.table.fetchData();
    },
    getFormItemByInputItem(item = {}) {
      const { lastItemClicked } = this;
      const lastKeyItemClicked = lastItemClicked && lastItemClicked.id;
      console.log("item:", item);
      console.log("lastItemClicked:", lastItemClicked);
      return {
        // "XXXPROP_USER_id": "",
        id: item.id,
        uid: item.uid,
        name: item.name,
        password: item.password,
        sex: item.sex,
        phone: item.phone,
        email: item.email,
        postCode: item.postCode,
        address: item.address,
        areaId: item.areaId,
        orgId: item.orgId,
        headPortrait: item.headPortrait,
        forecaster: item.forecaster
        // "XXXPROP_USER_4": lastKeyItemClicked,
        // ...item
      };
    }
  }
};
</script>
<style scoped>
</style>
